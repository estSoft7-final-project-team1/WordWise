<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Swiper demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1"/>
    <!-- Link Swiper's CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

    <!-- Demo styles -->
    <style>
        html,
        body {
            position: relative;
            height: 100%;
        }

        body {
            background: #eee;
            font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
            font-size: 14px;
            color: #000;
            margin: 0;
            padding: 0;
        }

        .swiper {
            margin: 100px auto;
            width: 320px;
            height: 240px;
        }

        .swiper-slide {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            padding: 10px;
            box-sizing: border-box;
            text-align: center;
        }

        .swiper-slide:nth-child(1n) {
            background-color: rgb(206, 17, 17);
        }

        .swiper-slide:nth-child(2n) {
            background-color: rgb(0, 140, 255);
        }

        .swiper-slide:nth-child(3n) {
            background-color: rgb(10, 184, 111);
        }

        .swiper-slide:nth-child(4n) {
            background-color: rgb(211, 122, 7);
        }

        .swiper-slide:nth-child(5n) {
            background-color: rgb(118, 163, 12);
        }

        .swiper-slide:nth-child(6n) {
            background-color: rgb(180, 10, 47);
        }

        .swiper-slide:nth-child(7n) {
            background-color: rgb(35, 99, 19);
        }

        .swiper-slide:nth-child(8n) {
            background-color: rgb(0, 68, 255);
        }

        .swiper-slide:nth-child(9n) {
            background-color: rgb(218, 12, 218);
        }

        .swiper-slide:nth-child(10n) {
            background-color: rgb(54, 94, 77);
        }

        .answer-box {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 320px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>

<body>
<!-- Swiper -->
<div class="swiper mySwiper3">
    <div class="swiper-wrapper">
        <!-- ë°˜ë³µ êµ¬ì¡° ì‹œì‘ -->
        <div th:each="item : ${testList}" class="swiper-slide"
             th:data-question="${item.questionId}"
             th:data-example="${item.exampleId}">
            <p>Word: <span th:text="${item.word}" id ="answer">Default Word</span></p>
            <p>Sentence: <span th:text="${item.sentence}" id="sentence">Default Sentence</span></p>
            <p>Sentence Meaning: <span th:text="${item.sentenceMeaning}" id ="translation">Default Sentence Meaning</span></p>
        </div>
        <!-- ë°˜ë³µ êµ¬ì¡° ë -->
    </div>
</div>
<!-- Fixed Answer Input -->
<div class="answer-box">
    <input type="text" id="userAnswer" placeholder="Your Answer"/>
    <button id="checkAnswer" onclick="handleAnswerSubmission(Event)">Check Answer</button>
    <p id="resultMessage"></p>
</div>

<button id="showAnswer" style="display: none">ì •ë‹µí™•ì¸</button>

<div id="resultSection" style="display: none;">
    <h3>ì‹œí—˜ì´ ëë‚¬ìŠµë‹ˆë‹¤!</h3>
    <div id="wrongAnswerList"></div>
    <button id="retryTestButton">ì¬ì‹œí—˜ ë³´ê¸°</button>
    <button id="endTestButton">ì‹œí—˜ ì¢…ë£Œ</button>
</div>
<!-- Swiper JS -->
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<!-- Initialize Swiper -->
<script>
    function swipe() {
        return new Swiper(".mySwiper3", {
            effect: "coverflow",
            grabCursor: true,
            centeredSlides: true,
            slidesPerView: "auto",
            coverflowEffect: {
                rotate: 50,
                stretch: 0,
                depth: 100,
                modifier: 1,
                slideShadows: true,
            },
        });
    }
    let swiper3 = swipe();
    let wrongAnswers = [];
    const answerCollection = [];


    document.getElementById('showAnswer').addEventListener('click', function () {
        const previousSlide = document.querySelector('.swiper-slide-prev');
        const correctAnswer = previousSlide.querySelector('#answer')?.textContent || "ì •ë³´ ì—†ìŒ";
        const sentence = previousSlide.querySelector('#sentence')?.textContent || "ì •ë³´ ì—†ìŒ";
        const sentenceMeaning = previousSlide.querySelector('#translation')?.textContent || "ì •ë³´ ì—†ìŒ";
        const userAnswer = document.getElementById('userAnswer').value.trim(); // ìœ ì €ê°€ ì…ë ¥í•œ ì •ë‹µ

        const resultMessage = document.getElementById('resultMessage');
        resultMessage.innerHTML = `
            <p><strong>ì‚¬ìš©ìê°€ ì œì¶œí•œ ì •ë‹µ :</strong> ${userAnswer}</p>
            <p><strong>ì˜ˆë¬¸ :</strong> ${sentence}</p>
            <p><strong>í•´ì„¤ :</strong> ${sentenceMeaning}</p>
            <p><strong>ì •ë‹µ:</strong> ${correctAnswer}</p>
        `;
        resultMessage.style.color = "blue";
    });


    document.getElementById('checkAnswer').addEventListener('click', handleAnswerSubmission);
    document.getElementById('userAnswer').addEventListener('keydown', handleAnswerSubmission);

    function handleAnswerSubmission(event) {
        // 'keydown' ì´ë²¤íŠ¸ì—ì„œ Enter í‚¤ë§Œ ì²˜ë¦¬
        if (event.type === 'click' || (event.type === 'keydown' && event.key === 'Enter')) {
            processAnswer();
        }
    }

    function processAnswer() {
        const userAnswer = document.getElementById('userAnswer').value.toLowerCase();
        if (!userAnswer) {
            const resultMessage = document.getElementById('resultMessage');
            resultMessage.textContent = "ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!";
            resultMessage.style.color = "orange";
            return; // ë¹ˆ ê°’ì¼ ê²½ìš° í•¨ìˆ˜ ì¢…ë£Œ
        }

        const currentSlide = document.querySelector('.swiper-slide-active');
        const question = currentSlide.getAttribute('data-question').trim();
        const example = currentSlide.getAttribute('data-example').trim();
        let isCorrect = false;

        const word = currentSlide.querySelector('#answer')?.textContent || "ì •ë³´ ì—†ìŒ";
        const sentence = currentSlide.querySelector('#sentence')?.textContent || "ì •ë³´ ì—†ìŒ";
        const sentenceMeaning = currentSlide.querySelector('#translation')?.textContent || "ì •ë³´ ì—†ìŒ";

        if (!question || !example) {
            console.error("ìŠ¬ë¼ì´ë“œ ë°ì´í„°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            return;
        }

        if (userAnswer === word) {
            resultMessage.textContent = "ì •ë‹µì…ë‹ˆë‹¤!";
            resultMessage.style.color = "green";
            // ì •ë‹µ í™•ì¸ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            document.getElementById('showAnswer').style.display = "none";
            // ë‹¤ìŒ ìŠ¬ë¼ì´ë“œë¡œ ì´ë™
            isCorrect = true;
            moveToNextSlide()
        } else {
            wrongAnswers.push({
                word: word,
                sentence: sentence,
                sentenceMeaning: sentenceMeaning,
                questionId: question,
                exampleId: example
            })
            isCorrect = false;
            resultMessage.textContent = "ì˜¤ë‹µì…ë‹ˆë‹¤. ";
            resultMessage.style.color = "red";
            document.getElementById('showAnswer').style.display = "block";
            moveToNextSlide()
            console.log("Wrong Answer : {}", wrongAnswers);
        }

        const answerDto = {
            answer: word,
            userAnswer: userAnswer,
            questionId: question,
            exampleId: example,
            isCorrect: isCorrect
        }

        addAnswerToCollection(answerDto);

    }


    // ì˜¤ë‹µì„ ê¸°ì¤€ìœ¼ë¡œ ì¬ì‹œí—˜ ìƒì„±
    function createWrongAnswerTest() {
        // Swiper ì¸ìŠ¤í„´ìŠ¤ ì‚­ì œ
        swiper3.destroy(true, true);

        // ê¸°ì¡´ ìŠ¬ë¼ì´ë“œ DOM ì œê±°
        const swiperWrapper = document.querySelector('.swiper-wrapper');
        swiperWrapper.innerHTML = '';

        // í‹€ë¦° ë¬¸ì œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìƒˆë¡œìš´ ìŠ¬ë¼ì´ë“œ ì¶”ê°€
        wrongAnswers.forEach((item) => {
            const slideHtml = `
            <div class="swiper-slide"
                 data-question="${item.questionId}"
                 data-example="${item.exampleId}">
                <p>Word: <span id="answer">${item.word}</span></p>
                <p>Sentence: <span id="sentence">${item.sentence}</span></p>
                <p>Sentence Meaning: <span id="translation">${item.sentenceMeaning}</span></p>
            </div>`;
            swiperWrapper.innerHTML += slideHtml;
        });

        // ìƒˆë¡œìš´ Swiper ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
        swiper3 = swipe();

        wrongAnswers = [];
    }

    // ìŠ¬ë¼ì´ë“œ ì´ë™ , ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ë“œë¥¼ ë„˜ì–´ê°ˆ ê²½ìš° ì²˜ë¦¬
    function moveToNextSlide() {
        if (swiper3.isEnd) {
            console.log("ë„ë‹¬");
            testEnd();
            fetch('/evaluate-answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(answerCollection)
            })
                .then(response => response.json()) // ë°±ì—”ë“œì—ì„œ ì…ë ¥ë°›ì€ ë°ì´í„°ë¥¼ json í˜•íƒœë¡œ ë°›ì•„ì˜¨ë‹¤
                .then(data => {// ë°˜í™˜ëœ jsonì„ dataí˜•íƒœë¡œ ë°›ì•„ì˜¨ë‹¤.
                    console.log("worngAnswers : ", wrongAnswers);
                });
        } else {
            swiper3.slideNext();
        }
    }

    function addAnswerToCollection(answerDto) {
        const isDuplicate = answerCollection.some(
            (item) => item.exampleId === answerDto.exampleId
        )
        if (!isDuplicate) {
            answerCollection.push(answerDto);
        }
    }

    function testEnd() {
        const wrongAnswerList = document.getElementById('wrongAnswerList');

        // í‹€ë¦° ë¬¸ì œ ëª©ë¡ ìƒì„±
        if (wrongAnswers.length > 0) {
            // í‹€ë¦° ë¬¸ì œ ëª©ë¡ ì´ˆê¸°í™”
            wrongAnswerList.innerHTML = '<p>ì•„ë˜ëŠ” í‹€ë¦° ë¬¸ì œ ëª©ë¡ì…ë‹ˆë‹¤:</p>\n';
            wrongAnswers.forEach(item => {
                const listItem = document.createElement('div');
                listItem.innerHTML = `
                <p><strong>Word:</strong> ${item.word}</p>
                <p><strong>Sentence:</strong> ${item.sentence}</p>
                <p><strong>Meaning:</strong> ${item.sentenceMeaning}</p>
                <hr>
            `;
                wrongAnswerList.appendChild(listItem);
            });
        } else {
            wrongAnswerList.innerHTML = `<p>ëª¨ë“  ë¬¸ì œë¥¼ ë§ì·„ìŠµë‹ˆë‹¤! ì¶•í•˜í•©ë‹ˆë‹¤ ğŸ‰</p>`;
        }

        // ê²°ê³¼ ì„¹ì…˜ ë³´ì—¬ì£¼ê¸°
        document.getElementById('resultSection').style.display = 'block';
        document.querySelector('.swiper').style.display = 'none';
        document.querySelector('.answer-box').style.display = 'none';
        document.getElementById('showAnswer').style.display = "none";
    }

    // ì¬ì‹œí—˜ ê¸°ëŠ¥
    document.getElementById('retryTestButton').addEventListener('click', function () {
        createWrongAnswerTest(); // í‹€ë¦° ë¬¸ì œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¬ì‹œí—˜ ìƒì„±
        document.querySelector('.swiper').style.display = 'block';
        document.querySelector('.answer-box').style.display = 'block';
        document.getElementById('resultSection').style.display = 'none';
    });

    // ì‹œí—˜ ì¢…ë£Œ ê¸°ëŠ¥
    document.getElementById('endTestButton').addEventListener('click', function () {
        alert("ì‹œí—˜ì„ ì¢…ë£Œí•©ë‹ˆë‹¤. ê²°ê³¼ëŠ” í†µê³„ í˜ì´ì§€ì—ì„œ í™•ì¸í•˜ì„¸ìš”.");
        window.location.href = "/wordtest/statistics"; // ì¢…ë£Œ í›„ í†µê³„ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    });
</script>
</body>

</html>


<!--        // fetch('/evaluate-answer', {-->
<!--        //     method: 'POST',-->
<!--        //     headers: {-->
<!--        //         'Content-Type': 'application/json'-->
<!--        //     },-->
<!--        //     body: JSON.stringify(answerCollection)-->
<!--        // })-->
<!--        //     .then(response => response.json()) // ë°±ì—”ë“œì—ì„œ ì…ë ¥ë°›ì€ ë°ì´í„°ë¥¼ json í˜•íƒœë¡œ ë°›ì•„ì˜¨ë‹¤-->
<!--        //     .then(data => {// ë°˜í™˜ëœ jsonì„ dataí˜•íƒœë¡œ ë°›ì•„ì˜¨ë‹¤.-->
<!--        //         console.log("data : ", data);-->
<!--        //     //     const resultMessage = document.getElementById('resultMessage');-->
<!--        //     //-->
<!--        //     //     if (data.answer) {-->
<!--        //     //         resultMessage.textContent = "ì •ë‹µì…ë‹ˆë‹¤!";-->
<!--        //     //         resultMessage.style.color = "green";-->
<!--        //     //         // ì •ë‹µ í™•ì¸ ë²„íŠ¼ ìˆ¨ê¸°ê¸°-->
<!--        //     //         document.getElementById('showAnswer').style.display = "none";-->
<!--        //     //         // ë‹¤ìŒ ìŠ¬ë¼ì´ë“œë¡œ ì´ë™-->
<!--        //     //         moveToNextSlide()-->
<!--        //     //         console.log("Wrong Answer : {}", wrongAnswers);-->
<!--        //     //     } else {-->
<!--        //     //         resultMessage.textContent = "ì˜¤ë‹µì…ë‹ˆë‹¤. ";-->
<!--        //     //         resultMessage.style.color = "red";-->
<!--        //     //         document.getElementById('showAnswer').style.display = "block";-->
<!--        //     //         moveToNextSlide()-->
<!--        //     //         console.log("Wrong Answer : {}", wrongAnswers);-->
<!--        //     //     }-->
<!--        //     // })-->
<!--        //     // .catch(error => {-->
<!--        //     //     console.error('Error:', error);-->
<!--        //      });-->
